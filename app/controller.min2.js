(function(){'use strict';angular.module('ticketingApp.Controller',["angucomplete-alt"]).controller('TicketingSearchCtrl',['$scope','$timeout','$filter','$location','savedFilter','ticketingService','angularGridInstance','$httpParamSerializer',TicketingSearchCtrl]).filter('removeHTMLTags',[removeHTMLTags]).filter('escapeFilter',[escapeFilter]).filter('replace',[replace]).directive('initialSearch',[initialSearch]).directive('searchResults',[searchResults]).directive('filters',[filters]).directive('item',['$timeout','angularGridInstance',item]).controller('TicketDetailCtrl',['ticketingService','$interval','getURL','$routeParams','$scope','$timeout',TicketDetailCtrl]).directive('detailDetails',[detailDetails]).directive('detailSidebar',[detailSidebar]).directive('detailAlternative',[detailAlternative]).directive('detailRelated',['$timeout','angularGridInstance',detailRelated]).directive('operators',[operators]).directive('modalDialog',[modalDialog]).directive('tabs',[tabs]).directive('pane',[pane]).directive('tooltip',[tooltip]);function TicketingSearchCtrl($scope,$timeout,$filter,$location,savedFilter,ticketingService,angularGridInstance,$httpParamSerializer){var vm=this;vm.submit=submit;vm.clearFilter=clearFilter;vm.getStations=getStations;vm.getoocStations=getoocStations;vm.geticStations=geticStations;vm.clearFromStation=clearFromStation;vm.clearToStation=clearToStation;vm.clearStation=clearStation;vm.getSwiftPAYG=getSwiftPAYG;vm.updateGrid=updateGrid;vm.update=update;vm.loadMore=loadMore;vm.loadMoreExact=loadMoreExact;vm.filterButtons={"operator":[],"operatorLength":0,"busTravelArea":[],"railZoneFrom":[],"railZoneTo":[]};vm.toggleFilter=toggleFilter;vm.swiftPAYG=swiftPAYG;vm.ntrainOOC=ntrainOOC;vm.toggleModalSwift=toggleModalSwift;function defaultVars(){vm.all=[];vm.filteredTickets=[];vm.origTickets=[];vm.otherTickets=[];vm.stationList=[];vm.stationoocList=[];vm.stationicList=[];vm.swiftPaygTickets=[];vm.loadingStatus='';vm.passValue='';vm.orderBy="orderSequence";vm.limit=parseInt($location.search().limit)||6;vm.limitExact=parseInt($location.search().limitExact)||6;vm.postJSON={"allowBus":$location.search().allowBus||null,"allowMetro":$location.search().allowMetro||null,"allowTrain":$location.search().allowTrain||null,"passengerType":$location.search().passengerType||'',"timeBand":$location.search().timeBand||'',"brand":$location.search().brand||null,"stationNames":$location.search().stationNames||[[]]};$scope.stationFromName=null;$scope.stationToName=null;$scope.stationFromTitle=null;$scope.stationToTitle=null;$scope.stationFromNameOocZ5=null;$scope.stationToNameOocZ5=null;$scope.buyOnDirectDebitParameter=$location.search().buyOnDirectDebit||null;$scope.buyOnDirectPurchaseParameter=$location.search().buyOnDirectPurchase||null;$scope.buyOnSwiftParameter=$location.search().buyOnSwift||null;$scope.hasOnlinePurchaseChannelParameter=$location.search().hasOnlinePurchaseChannel||null;$scope.purchaseTicParameter=$location.search().purchaseTic||null;$scope.purchaseRailStationParameter=$location.search().purchaseRailStation||null;$scope.purchasePayzoneParameter=$location.search().purchasePayzone||null;$scope.busTravelAreaParameter=$location.search().busTravelArea||null;$scope.operatorParameter=$location.search().operator||null;$scope.railZoneFromParameter=$location.search().railZoneFrom||null;$scope.railZoneToParameter=$location.search().railZoneTo||null;vm.clearModes=clearModes;vm.postedJSON={}}
defaultVars();if(($location.search().allowBus||$location.search().allowMetro||$location.search().allowTrain)||($location.search().brand)&&$location.search().passengerType&&$location.search().timeBand||$location.search().busTravelArea||$location.search().operator||$location.search().stationNames||$location.search().brand){vm.clearStation();submit(vm.postJSON)}else{$location.url('').replace()}
if($location.search().brand==='Swift PAYG'){getSwiftPAYG();swiftPAYG()}
function submit(data){vm.loadingStatus='loading';angular.copy(vm.postJSON,vm.postedJSON);$location.search({allowBus:vm.postedJSON.allowBus,allowTrain:vm.postedJSON.allowTrain,allowMetro:vm.postedJSON.allowMetro,passengerType:vm.postedJSON.passengerType,timeBand:vm.postedJSON.timeBand,brand:vm.postedJSON.brand,stationNames:vm.postedJSON.stationNames,buyOnDirectDebit:$scope.buyOnDirectDebitParameter,buyOnDirectPurchase:$scope.buyOnDirectPurchaseParameter,buyOnSwift:$scope.buyOnSwiftParameter,hasOnlinePurchaseChannel:$scope.hasOnlinePurchaseChannelParameter,purchaseTic:$scope.purchaseTicParameter,purchaseRailStation:$scope.purchaseRailStationParameter,purchasePayzone:$scope.purchasePayzoneParameter,busTravelArea:$scope.busTravelAreaParameter,operator:$scope.operatorParameter,railZoneFrom:$scope.railZoneFromParameter,railZoneTo:$scope.railZoneToParameter,limit:vm.limit,limitExact:vm.limitExact,});vm.searchFilters={};vm.origFilters={};console.log('this is posted');console.log(vm.postedJSON);ticketingService.ticketSearch(data).then(function(response){vm.all=response;var fbus=vm.postedJSON.allowBus||!1;var ftrain=vm.postedJSON.allowTrain||!1;var fmetro=vm.postedJSON.allowMetro||!1;vm.exactMatch=$filter('filter')(response,{allowBus:fbus,allowTrain:ftrain,allowMetro:fmetro},!0);var searchAll=vm.all;var searchExact=vm.exactMatch;for(var i=0;i<searchExact.length;i++){var arrlen=searchAll.length;for(var j=0;j<arrlen;j++){if(searchExact[i]===searchAll[j]){searchAll=searchAll.slice(0,j).concat(searchAll.slice(j+1,arrlen))}}}
vm.otherResults=searchAll}),ticketingService.ticketSearch(data).then(function(response){vm.all=response;vm.original=response;angular.forEach(vm.all,function(item){if(vm.filterButtons.operator.indexOf(item.operator)===-1){vm.filterButtons.operator.push(item.operator)}
if(vm.filterButtons.busTravelArea.indexOf(item.busTravelArea)===-1){vm.filterButtons.busTravelArea.push(item.busTravelArea)}
if(vm.filterButtons.railZoneFrom.indexOf(item.railZoneFrom)===-1){vm.filterButtons.railZoneFrom.push(item.railZoneFrom)}
if(vm.filterButtons.railZoneTo.indexOf(item.railZoneTo)===-1){vm.filterButtons.railZoneTo.push(item.railZoneTo)}});if($location.search().stationNames){var stations=$location.search().stationNames;var stationSel=stations.toString();var stationSplit=stationSel.split(',');$scope.stationFromName=stationSplit[0];$scope.stationToName=stationSplit[1]}
var bus=vm.postedJSON.allowBus;var train=vm.postedJSON.allowTrain;var metro=vm.postedJSON.allowMetro;if(bus!==null||bus!==null&&train!==null||bus!==null&&metro!==null||train!==null&&metro!==null){vm.toggleFilter('mode')}
if(bus!==null&&train!==null&&metro!==null){vm.toggleFilter('payment')}
vm.update();vm.loadingStatus='success'})}
function update(){var filtered=vm.all;var filteredorg=vm.exactMatch;var filteredother=vm.otherResults;angular.forEach(vm.searchFilters,function(val,key){if((key.indexOf('allow')!==-1&&val)||(val===!1&&key.indexOf('allow')===-1)){delete vm.searchFilters[key]}});filtered=$filter('filter')(filtered,vm.searchFilters);filteredorg=$filter('filter')(filteredorg,vm.searchFilters);filteredother=$filter('filter')(filteredother,vm.searchFilters);vm.filteredTickets=$filter('orderBy')(filtered,vm.orderBy);vm.origTickets=$filter('orderBy')(filteredorg,vm.orderBy);vm.otherTickets=$filter('orderBy')(filteredother,vm.orderBy);vm.updateGrid()}
function updateGrid(){$timeout(function(){$timeout(function(){if(vm.filteredTickets.length){angularGridInstance.ticketResults.refresh();angularGridInstance.origTicketResults.refresh();var obj={passengerType:vm.postedJSON.passengerType,timeBand:vm.postedJSON.timeBand,brand:vm.postedJSON.brand,stationNames:vm.postedJSON.stationNames,busTravelArea:vm.searchFilters.busTravelArea,operator:vm.searchFilters.operator,buyOnDirectDebit:vm.searchFilters.buyOnDirectDebit,buyOnDirectPurchase:vm.searchFilters.buyOnDirectPurchase||null,buyOnSwift:vm.searchFilters.buyOnSwift,hasOnlinePurchaseChannel:vm.searchFilters.hasOnlinePurchaseChannel,purchaseTic:vm.searchFilters.purchaseTic,purchaseRailStation:vm.searchFilters.purchaseRailStation,purchasePayzone:vm.searchFilters.purchasePayzone,railZoneFrom:vm.searchFilters.railZoneFrom,railZoneTo:vm.searchFilters.railZoneTo,limit:vm.limit,limitExact:vm.limitExact};var urlstring=$httpParamSerializer(obj);var abus;if(vm.postedJSON.allowBus){abus="allowBus"}
var atrain;if(vm.postedJSON.allowTrain){atrain="allowTrain"}
var ametro;if(vm.postedJSON.allowMetro){ametro="allowMetro"}
var searchURL;if(vm.postedJSON.allowBus&&!vm.postedJSON.allowTrain&&!vm.postedJSON.allowMetro){searchURL="/?"+abus+"&"+urlstring;savedFilter.set("url",searchURL);var qwertyqw=vm.searchFilters.operator;savedFilter.set("operator",qwertyqw)}
if(vm.postedJSON.allowBus&&vm.postedJSON.allowTrain&&!vm.postedJSON.allowMetro){searchURL="/?"+abus+"&"+atrain+"&"+urlstring;savedFilter.set("url",searchURL)}
if(vm.postedJSON.allowBus&&!vm.postedJSON.allowTrain&&vm.postedJSON.allowMetro){searchURL="/?"+abus+"&"+ametro+"&"+urlstring;savedFilter.set("url",searchURL)}
if(!vm.postedJSON.allowBus&&vm.postedJSON.allowTrain&&!vm.postedJSON.allowMetro){searchURL="/?"+atrain+"&"+urlstring;savedFilter.set("url",searchURL)}
if(!vm.postedJSON.allowBus&&vm.postedJSON.allowTrain&&vm.postedJSON.allowMetro){searchURL="/?"+atrain+"&"+ametro+"&"+urlstring;savedFilter.set("url",searchURL)}
if(!vm.postedJSON.allowBus&&!vm.postedJSON.allowTrain&&vm.postedJSON.allowMetro){searchURL="/?"+ametro+"&"+urlstring;savedFilter.set("url",searchURL)}
if(vm.postedJSON.allowBus&&vm.postedJSON.allowTrain&&vm.postedJSON.allowMetro){searchURL="/?"+abus+"&"+atrain+"&"+ametro+"&"+urlstring;savedFilter.set("url",searchURL)}
if(!vm.postedJSON.allowBus&&!vm.postedJSON.allowTrain&&!vm.postedJSON.allowMetro){searchURL="/?"+urlstring;savedFilter.set("url",searchURL)}
vm.loadingStatus="success"}},0,!1)},0,!1)}
function getStations(){ticketingService.getStations().then(function(response){console.log("rail stations");console.log(response);vm.stationList=response})}
function getoocStations(){ticketingService.getStations().then(function(response){console.log("out of county stations");console.log(response);var OutOfCounty=$filter('filter')(response,{outOfCounty:"true"});vm.stationoocList=OutOfCounty})}
function geticStations(){ticketingService.getStations().then(function(response){var inCounty=$filter('filter')(response,{outOfCounty:"false"});vm.stationicList=inCounty})}
function clearFilter(){$location.url('').replace();defaultVars();$scope.buyOnDirectDebitCheck=function(){return!1};$scope.buyOnDirectPurchaseCheck=function(){return!1};$scope.buyOnSwiftCheck=function(){return!1};$scope.hasOnlinePurchaseChannelCheck=function(){return!1};$scope.purchaseTicCheck=function(){return!1};$scope.purchaseRailStationCheck=function(){return!1};$scope.purchasePayzoneCheck=function(){return!1}}
function clearModes(){vm.postJSON.allowBus=null;vm.postJSON.allowTrain=null;vm.postJSON.allowMetro=null}
function clearStation(){if($location.search().stationNames==="[]"){vm.clearFromStation()}}
$scope.stationFromName=null;$scope.stationFromReq=!1;$scope.stationFrom=function(selected){if(selected){$scope.stationFromName=selected.originalObject.name;vm.postJSON.stationNames[0]=selected.originalObject.name;$scope.stationFromTitle=selected.originalObject.name;$scope.stationFromNameZone=selected.originalObject.zone;$scope.stationFromNameOoc=selected.originalObject.outOfCounty;$scope.stationFromNameOocZ5=selected.originalObject.zone5InCounty;$scope.stationToReq=!0}else{$scope.stationFromName=null;vm.postJSON.stationNames[0]=null;$scope.stationFromTitle=null}};function clearFromStation(){$scope.$broadcast('angucomplete-alt:clearInput','stationFrom');$scope.stationFromName=null;vm.postJSON.stationNames=[[]];$scope.stationFromReq=!1;$scope.stationFromNameOocZ5=null}
$scope.stationToName=null;$scope.stationToReq=!1;$scope.stationTo=function(selected){if(selected){$scope.stationToName=selected.originalObject.name;vm.postJSON.stationNames[1]=selected.originalObject.name;$scope.stationToTitle=selected.originalObject.name;$scope.stationToNameZone=selected.originalObject.zone;$scope.stationToNameOoc=selected.originalObject.outOfCounty;$scope.stationToNameOocZ5=selected.originalObject.zone5InCounty;$scope.stationFromReq=!0}else{$scope.stationToName=null;vm.postJSON.stationNames[1]=null;$scope.stationToTitle=null}};function clearToStation(){$scope.$broadcast('angucomplete-alt:clearInput','stationTo');$scope.stationToName=null;vm.postJSON.stationNames=[[]];$scope.stationToReq=!1;$scope.stationToNameOocZ5=null}
if($scope.buyOnDirectDebitParameter){vm.filterButtons.payment=!vm.filterButtons.payment;vm.searchFilters.buyOnDirectDebit=!0;$scope.buyOnDirectDebitCheck=function(){return!0}}
if($scope.buyOnDirectPurchaseParameter){vm.filterButtons.payment=!vm.filterButtons.payment;vm.searchFilters.buyOnDirectPurchase=!0;$scope.buyOnDirectPurchaseCheck=function(){return!0}}
if($scope.buyOnSwiftParameter){vm.filterButtons.payment=!vm.filterButtons.payment;vm.searchFilters.buyOnSwift=!0;$scope.buyOnSwiftCheck=function(){return!0}}
if($scope.hasOnlinePurchaseChannelParameter){vm.filterButtons.payment=!vm.filterButtons.payment;vm.searchFilters.hasOnlinePurchaseChannel=!0;$scope.hasOnlinePurchaseChannelCheck=function(){return!0}}
if($scope.purchaseTicParameter){vm.filterButtons.payment=!vm.filterButtons.payment;vm.searchFilters.purchaseTic=!0;$scope.purchaseTicCheck=function(){return!0}}
if($scope.purchaseRailStationParameter){vm.filterButtons.payment=!vm.filterButtons.payment;vm.searchFilters.purchaseRailStation=!0;$scope.purchaseRailStationCheck=function(){return!0}}
if($scope.purchasePayzoneParameter){vm.filterButtons.payment=!vm.filterButtons.payment;vm.searchFilters.purchasePayzone=!0;$scope.purchasePayzoneCheck=function(){return!0}}
if($scope.busTravelAreaParameter){vm.filterButtons.busTravelAreaBtn=!vm.filterButtons.busTravelAreaBtn;vm.searchFilters.busTravelArea=$scope.busTravelAreaParameter}
if($scope.operatorParameter){vm.filterButtons.operatorBtn=!vm.filterButtons.operatorBtn;vm.searchFilters.operator=$scope.operatorParameter}
if($scope.railZoneFromParameter){vm.filterButtons.railZoneBtn=!vm.filterButtons.railZoneBtn;vm.searchFilters.railZoneFrom=$scope.railZoneFromParameter}
if($scope.railZoneToParameter){vm.filterButtons.railZoneBtn=!vm.filterButtons.railZoneBtn;vm.searchFilters.railZoneTo=$scope.railZoneToParameter}
vm.modalShownSwift=!1;function toggleModalSwift(){vm.modalShownSwift=!vm.modalShownSwift}
function loadMore(){vm.limit+=6;$location.search('limit',vm.limit);vm.updateGrid()}
function loadMoreExact(){vm.limitExact+=6;$location.search('limitExact',vm.limitExact);vm.updateGrid()}
function toggleFilter(type){vm.filterButtons[type]=!vm.filterButtons[type]}
function swiftPAYG(){vm.passValue=vm.postJSON.brand;if(vm.passValue==='Swift PAYG'){vm.isHideCheck=!vm.isHideCheck;vm.postJSON.passengerType=null;vm.postJSON.timeBand=null;vm.postJSON.stationNames=[]}else{if(vm.passValue==='nbus'||vm.passValue==='National Express'||vm.passValue==='Diamond Bus'||vm.passValue==='Stagecoach'||vm.passValue==='Swift PAYG'||vm.passValue==='West Midlands Metro'){vm.postJSON.stationNames=[[]]}}}
function ntrainOOC(){vm.passValue=vm.postJSON.brand;if(vm.passValue==='ntrain - Out of County'){vm.isHideCheck=!vm.isHideCheck}}
function getSwiftPAYG(){ticketingService.getSwiftSearch().then(function(response){vm.swiftPaygTickets=response})}
$scope.date=new Date()}
function removeHTMLTags(){return function(text){return text?String(text).replace(/<[^>]+>/gm,''):''}}
function escapeFilter(){return function(text){return text?String(text).replace(/\n/gm,'<br><br>'):''}}
function replace(){return function(input,from,to){if(input===undefined){return}
var regex=new RegExp(from,'g');return input.replace(regex,to)}}
function initialSearch(){return{templateUrl:'partials/search-results/initial-search.html',restrict:'E'}}
function searchResults(){return{templateUrl:'partials/search-results/search-results.html',restrict:'E'}}
function filters(){return{templateUrl:'partials/search-results/filters.html',restrict:'E'}}
function item($timeout,angularGridInstance){return{templateUrl:'partials/search-results/item.html',restrict:'E',link:function(scope,element,attrs){$timeout(function(){if(scope.$last){angularGridInstance.ticketResults.refresh()}},0)}}}
function TicketDetailCtrl(ticketingService,$interval,getURL,$routeParams,$scope,$timeout){var vm=this;vm.loadingText='Loading...';vm.loadingStatus='loading';vm.loadingArray=['Well, what are you waiting for?','Are we there yet?','Warming up the processors...','Reconfiguring the office coffee machine...','Doing something useful...','Are you ready?','So, do you come here often?','This may take some time...','I know this is painful to watch, but I have to load this.','Oh, no! Loading time...','Still Waiting... huh','Waiting for something in the server.','Creating randomly generated feature.',"It's not you. It's me.",'Eating your internet cookies...Yummy!'];vm.loading=$interval(function(){vm.loadingText=vm.loadingArray[Math.round(Math.random()*(vm.loadingArray.length-1))]},3500);vm.ticketID=$routeParams.ticket;vm.filterAccordions={};vm.relatedTickets={};vm.toggleClick=toggleClick;vm.modalShown=!1;vm.toggleModal=toggleModal;vm.toggleModalBus=toggleModalBus;vm.toggleModalTrain=toggleModalTrain;vm.toggleModalSwift=toggleModalSwift;vm.operatorList=[];vm.limit=4;function initialise(data){ticketingService.getTicket(data).then(function(response){vm.all=response;console.log(response);if(vm.all.relatedTickets.length){angular.forEach(vm.all.relatedTickets,function(item){ticketingService.getSimpleTicket(item.id).then(function(response){vm.relatedTickets[item.id]=response})})}else{}
if(vm.all.documents.length){ticketingService.getTerms(data).then(function(response){vm.relatedTerms=response})}else{}
ticketingService.getOperators().then(function(response){vm.operatorList=response;console.log(response)});backButtonLogic()})}
function backButtonLogic(){vm.backToSearch=getURL;console.log(vm.backToSearch);$scope.stationFromNameZone='1'}
initialise(vm.ticketID);function toggleClick(type){vm.filterAccordions[type]=!vm.filterAccordions[type]}
vm.modalShownBus=!1;function toggleModalBus(){vm.modalShownBus=!vm.modalShownBus}
vm.modalShownTrain=!1;function toggleModalTrain(){vm.modalShownTrain=!vm.modalShownTrain}
vm.modalShown=!1;function toggleModal(){vm.modalShown=!vm.modalShown}
vm.modalShownSwift=!1;function toggleModalSwift(){vm.modalShownSwift=!vm.modalShownSwift}
$timeout(function(){vm.loadingStatus="success"},0)}
function detailDetails(){return{templateUrl:'partials/detail/details.html',restrict:'E'}}
function detailSidebar(){return{templateUrl:'partials/detail/sidebar.html',restrict:'E'}}
function detailAlternative(){return{templateUrl:'partials/detail/alternative.html',restrict:'E'}}
function detailRelated($timeout,angularGridInstance){return{templateUrl:'partials/detail/related-product.html',restrict:'E',link:function(scope,element,attrs){$timeout(function(){if(scope.$last){angularGridInstance.alternativeResults.refresh()}},0)}}}
function operators(){return{templateUrl:'partials/detail/operator.html',restrict:'E'}}
function modalDialog(){return{restrict:'E',scope:{show:'='},replace:!0,transclude:!0,link:function(scope,element,attrs){scope.dialogStyle={};if(attrs.width)
scope.dialogStyle.width=attrs.width;if(attrs.height)
scope.dialogStyle.height=attrs.height;if(attrs.modalclass)
scope.dialogStyle.class=attrs.modalclass;scope.hideModal=function(){scope.show=!1}},template:'<div ng-show="show">'+'<div ng-show="show" class="modal" ng-click="hideModal()"></div>'+'<div class="ng-modal-dialog boxin modal-content {{dialogStyle.class}}" ng-style="dialogStyle">'+'<div class="ng-modal-close modal__close js-modal-close" ng-click="hideModal()">X</div>'+'<div class="ng-modal-dialog-content" ng-transclude></div>'+'</div>'+'</div>'}}
function tabs(){return{restrict:'E',transclude:!0,scope:{},controller:["$scope",function($scope){var panes=$scope.panes=[];$scope.select=function(pane){angular.forEach(panes,function(pane){pane.selected=!1});pane.selected=!0};this.addPane=function(pane){if(panes.length==0)$scope.select(pane);panes.push(pane)}}],template:'<div class="cfx">'+'<div class="arrdep-filters__toggle">'+'<div class="radio-bar">'+'<span ng-repeat="pane in panes" ng-class="{active:pane.selected}">'+'<input name="option" id="{{pane.title}}" type="radio">'+'<label ng-click="select(pane)" for="{{pane.title}}" style="height: 44px;">{{pane.title}}</label>'+'</span>'+'</div>'+'</div>'+'<div class="tab-content" ng-transclude></div>'+'</div>',replace:!0}}
function pane(){return{require:'^tabs',restrict:'E',transclude:!0,scope:{title:'@'},link:function(scope,element,attrs,tabsCtrl){tabsCtrl.addPane(scope)},template:'<div class="tab-pane" ng-class="{active: selected}" ng-transclude>'+'</div>',replace:!0}}
function tooltip(){return{restrict:'A',controller:function($scope,$element){$scope.isShown=!1;this.showHover=function(){$scope.isShown=$scope.isShown==!0?!1:!0}},transclude:!0,link:function(scope,element,attrs,ctrl){scope.copy=attrs.tooltipc;element.bind('click',function(){scope.$apply(function(){ctrl.showHover()})})},template:'<div ng-transclude></div>'+'<p class="field-help tooltip" ng-show="isShown">'+'<span class="close modal__close"></span>'+'<span data-ng-bind-html="copy"></span>'+'</p>'}}})()
