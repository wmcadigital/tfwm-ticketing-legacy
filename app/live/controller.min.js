!function(){"use strict";angular.module("timetablesApp.timetablesCtrl",[]).controller("TimetablesListingCtrl",["$http","$interval","$location","$window","$filter","filterFilter","savedFilter","timetablesService","angularGridInstance","$timeout","updatePageView",function(e,t,r,i,n,a,o,s,l,c,u){var d=this;function m(){d.all=[],d.filteredTimetables=[],d.timetablesStatus="",d.modes="",d.limit=parseInt(r.search().limit)||6,d.postJSON={SearchString:"",Modes:[]},d.postedJSON={},d.query={Service:{OperatorName:"All"}},d.update()}d.noResults='<h4>Oops! Sorry, no results found.</h4>Please enter your service number again, or why not try our <a class="btn-link" href="https://journeyplanner.networkwestmidlands.com/">Journey Planner</a>?<br/><br/>',d.clearFilter=function(){r.url("").replace(),m()},d.updateGrid=function(){c(function(){d.filteredTimetables.length&&(l.timetableResults.refresh(),o.set("url",r.url()))},0,!1)},d.update=function(e){var t;t="All"!=d.query.Service.OperatorName&&"Bus"==d.modes?n("filter")(d.all,d.query):d.all,d.filteredTimetables=d.filteredTimetables=n("orderBy")(t,"Service.ServiceNumber"),d.updateGrid()},d.submit=p,d.trainSubmit=h,d.loadMore=function(){d.limit+=6,r.search("limit",d.limit),d.updateGrid()},d.save=function(e){o.set("stateless",e)},m(),"Bus"==r.search().mode&&r.search().serviceNo||"Tram"==r.search().mode&&"MM1"==r.search().serviceNo?(d.postJSON.SearchString=r.search().serviceNo,d.modes=r.search().mode,p(d.postJSON)):"Train"==r.search().mode?(d.modes=r.search().mode,h()):r.url("").replace();function p(e){d.timetablesStatus="Loading",d.query={Service:{OperatorName:"All"}},d.postJSON.Modes=[d.modes],r.search({mode:d.postJSON.Modes,serviceNo:d.postJSON.SearchString,limit:d.limit}),angular.copy(d.postJSON,d.postedJSON),s.getAllTimetables(e).then(function(e){d.all=e,d.update(),d.operators=["All"],angular.forEach(d.all,function(e){-1===d.operators.indexOf(e.Service.OperatorName)&&d.operators.push(e.Service.OperatorName)}),u.update(),d.timetablesStatus="Success"})}function h(){d.timetablesStatus="Success",d.postJSON.Modes=[d.modes],r.search({mode:d.modes}),angular.copy(d.postJSON,d.postedJSON),u.update()}}]).filter("timetableURL",[function(){return function(e){return e=window.encodeURIComponent(e).replace(/%26/g,"_").replace(/%2F/g,"_").replace(/%2C/g,"_").replace(/%3A/g,"_").replace(/%40/g,"_")}}]).directive("initialSearch",[function(){return{templateUrl:"//static.centro.org.uk/nwmAssets/apps/timetables/partials/search-results/initial-search.html",restrict:"E"}}]).directive("searchResults",[function(){return{templateUrl:"//static.centro.org.uk/nwmAssets/apps/timetables/partials/search-results/search-results.html",restrict:"E"}}]).directive("item",["$timeout","angularGridInstance",function(e,t){return{templateUrl:"//static.centro.org.uk/Staging/nwmAssets/apps/timetables/partials/search-results/item.html",restrict:"E",link:function(r,i,n){e(function(){r.$last&&t.timetableResults.refresh()},0)}}}]).controller("TimetableCtrl",["$http","$routeParams","$location","timetablesService","getUnique","getURL","$interval","$filter","$timeout","$window","updatePageView",function(e,t,r,i,n,a,o,s,l,c,u){var d=this;function m(){i.getTTRoute(t.ttID+"/"+t.version+"/"+d.direction+"/"+d.when).then(function(e){d.route=e,d.loadingStatus="Success",o.cancel(d.loading);for(var t in d.getDate)d.getDate[t].IdValue==r.search().when&&(d.notes=d.getDate[t].Notes);d.notesStr=JSON.stringify(d.notes)})}function p(){d.getTimetableDir=d.detail[d.direction+"Timetables"].Timetables,d.getDate=s("orderBy")(d.getTimetableDir,"IdValue"),d.when=d.getDate[0].IdValue,d.notes=d.getDate[0].Notes}function h(){r.search({direction:d.direction,when:d.when}),r.replace(),document.title="Route: "+d.detail.BaseRoute.ServiceNumber+" - "+d.detail[d.direction+"Timetables"].RouteDescription+" - Network West Midlands",u.update()}d.ttID=t.ttID,d.loadingText="Loading...",d.loadingStatus="Loading",d.loadingArray=["Well, what are you waiting for?","Are we there yet?","Warming up the processors...","Reconfiguring the office coffee machine...","Doing something useful...","Are you ready?","So, do you come here often?","This may take some time...","I know this is painful to watch, but I have to load this.","Oh, no! Loading time...","Still Waiting... huh","Waiting for something in the server.","Creating randomly generated feature.","It's not you. It's me.","Eating your internet cookies...Yummy!"],d.loading=o(function(){d.loadingText=d.loadingArray[Math.round(Math.random()*(d.loadingArray.length-1))]},3500),d.color="",d.updateURL=h,d.changeDir=function(){d.direction="Outbound"==d.direction?"Inbound":"Outbound",p(),h()},d.activateTTRoute=m,d.versionChange=function(){r.path("/route/"+s("timetableURL")(d.versionSelect.stateless)+"-"+d.versionSelect.version)},d.otherVersions=[{label:"Select Version",version:"",stateless:""}],d.versionSelect={label:"Select Version",version:"",stateless:""},d.mapStatus="View",d.map=function(e){"View"==e||"changeDir"==e&&"Close"==d.mapStatus?(d.mapStatus="Loading",i.getRouteMap(t.ttID+"/"+t.version+"/"+d.direction).then(function(t){d.bounds=t.Bounds,d.coords=t.Coordinates,d.markers=[],angular.forEach(t.Coordinates,function(e,t){angular.forEach(e,function(r,i){0==t&&0==i?d.markers.push({lat:r.lat,lng:r.lng,marker:d.icon}):0==t&&i==e.length-1&&d.markers.push({lat:r.lat,lng:r.lng,marker:d.icon})})}),d.markers.push({lat:d.bounds[0].lat,lng:d.bounds[0].lng,marker:""},{lat:d.bounds[1].lat,lng:d.bounds[1].lng,marker:""}),d.mapStatus="View"==e?"Close":"View",l(function(){"View"==e?nwm.map.init():d.map(d.mapStatus)},0)})):d.mapStatus="View"},function(){i.getTTHeaders(t.ttID+"/"+t.version).then(function(e){if(e){if(d.detail=e,angular.forEach(d.detail.OtherVersions,function(e){-1===d.otherVersions.indexOf(e.Version)&&d.otherVersions.push({label:"Current"==e.ValidityString?"Up to date":e.ValidityString,version:e.Version,stateless:e.Stateless})}),d.currentVersion=s("filter")(d.otherVersions,{label:"Up to date"})[0],null!==e.OutboundTimetables&&null!==e.InboundTimetables?d.direction=r.search().direction&&["Outbound","Inbound"].indexOf(r.search().direction)>-1?r.search().direction:"Outbound":null!==e.OutboundTimetables?d.direction="Outbound"===r.search().direction?r.search().direction:"Outbound":d.direction="Inbound"===r.search().direction?r.search().direction:"Inbound",document.title="Route: "+e.BaseRoute.ServiceNumber+" - "+e[d.direction+"Timetables"].RouteDescription+" - Network West Midlands",angular.forEach(d.detail.CompositeRoutes,function(e){e.LineNameOutbound=e.LineName.replace("*","H"),e.LineNameInbound=e.LineName.replace("*","R")}),p(),r.search().when)for(var i in d.getDate)d.getDate[i].IdValue==r.search().when&&(d.when=r.search().when);2===d.detail.TransportMode||4==d.detail.TransportMode?(d.color="pink",d.icon="//static.centro.org.uk/img/nwm/modes/metro.png"):(d.color="orange",d.icon="//static.centro.org.uk/img/nwm/modes/bus.png"),function(){if(null!==n&&n.replace("%20"," ")==t.ttID)d.backToSearch=a;else{var e=5==d.detail.TransportMode?"Bus":"Tram";d.backToSearch="/?mode="+e+"&serviceNo="+d.detail.BaseRoute.ServiceNumber}}(),m()}else d.loadingStatus="Error"})}()}]).directive("topSection",[function(){return{templateUrl:"//static.centro.org.uk/nwmAssets/apps/timetables/partials/timetable/top-section.html",restrict:"E"}}]).directive("route",[function(){return{templateUrl:"//static.centro.org.uk/nwmAssets/apps/timetables/partials/timetable/route.html",restrict:"E"}}]).directive("sideBar",[function(){return{templateUrl:"//static.centro.org.uk/nwmAssets/apps/timetables/partials/timetable/side-bar.html",restrict:"E"}}]).directive("sidebarScroll",["$window","$timeout",function(e,t){return{restrict:"A",link:function(r,i,n){t(function(){t(function(){function t(){var t=e.pageYOffset>angular.element(".block--main").offset().top-40;t?i.is(":visible")||angular.element(i).removeClass("fieldset--hidden"):i.is(":visible")&&angular.element(i).addClass("fieldset--hidden")}t(),angular.element(e).bind("scroll",function(){t()})},0)},0)}}}]).directive("scrollTop",[function(){return{restrict:"A",link:function(e,t,r){t.on("click",function(e){angular.element("html, body").animate({scrollTop:angular.element(".breadcrumb").offset().top+30},500)})}}}])}();