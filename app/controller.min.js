!function(){"use strict";angular.module("ticketingApp.Controller",["angucomplete-alt"]).controller("TicketingSearchCtrl",["$scope","$timeout","$filter","$location","savedFilter","ticketingService","angularGridInstance","$httpParamSerializer",function(e,t,a,o,r,n,l,i){var s=this;function c(){s.all=[],s.filteredTickets=[],s.origTickets=[],s.otherTickets=[],s.stationList=[],s.stationoocList=[],s.stationicList=[],s.swiftPaygTickets=[],s.loadingStatus="",s.passValue="",s.orderBy="orderSequence",s.limit=parseInt(o.search().limit)||6,s.limitExact=parseInt(o.search().limitExact)||6,s.postJSON={allowBus:o.search().allowBus||null,allowMetro:o.search().allowMetro||null,allowTrain:o.search().allowTrain||null,passengerType:o.search().passengerType||"",timeBand:o.search().timeBand||"",brand:o.search().brand||null,stationNames:o.search().stationNames||[[]]},e.buyOnDirectDebitParameter=o.search().buyOnDirectDebit||null,e.buyOnDirectPurchaseParameter=o.search().buyOnDirectPurchase||null,e.buyOnSwiftParameter=o.search().buyOnSwift||null,e.hasOnlinePurchaseChannelParameter=o.search().hasOnlinePurchaseChannel||null,e.purchaseTicParameter=o.search().purchaseTic||null,e.purchaseRailStationParameter=o.search().purchaseRailStation||null,e.purchasePayzoneParameter=o.search().purchasePayzone||null,e.busTravelAreaParameter=o.search().busTravelArea||null,s.clearModes=d,s.postedJSON={}}s.submit=u,s.clearFilter=function(){o.url("").replace(),c(),e.stationFromName=null,e.stationToName=null,e.stationFromTitle=null,e.stationToTitle=null,e.stationFromNameOocZ5=null,e.stationToNameOocZ5=null},s.getStations=function(){n.getStations().then(function(e){s.stationList=e})},s.getoocStations=function(){n.getStations().then(function(e){var t=a("filter")(e,{OutOfCounty:"true"});s.stationoocList=t})},s.geticStations=function(){n.getStations().then(function(e){var t=a("filter")(e,{OutOfCounty:"false"});s.stationicList=t})},s.clearFromStation=function(){e.$broadcast("angucomplete-alt:clearInput","stationFrom"),e.stationFromName=null,s.postJSON.stationNames=[[]],e.stationFromReq=!1,e.stationFromNameOocZ5=null},s.clearToStation=function(){e.$broadcast("angucomplete-alt:clearInput","stationTo"),e.stationToName=null,s.postJSON.stationNames=[[]],e.stationToReq=!1,e.stationToNameOocZ5=null},s.clearStation=function(){"[]"==o.search().stationNames&&s.clearFromStation()},s.getSwiftPAYG=p,s.updateGrid=function(){t(function(){t(function(){if(s.filteredTickets.length){l.ticketResults.refresh(),l.origTicketResults.refresh();var e={passengerType:s.postedJSON.passengerType,timeBand:s.postedJSON.timeBand,brand:s.postedJSON.brand,stationNames:s.postedJSON.stationNames,busTravelArea:s.searchFilters.busTravelArea,buyOnDirectDebit:s.postedJSON.buyOnDirectDebit,limit:s.limit,limitExact:s.limitExact},t=i(e);if(s.postedJSON.allowBus)var a="allowBus";if(s.postedJSON.allowTrain)var o="allowTrain";if(s.postedJSON.allowMetro)var n="allowMetro";if(s.searchFilters.operator&&s.searchFilters.operator,s.postedJSON.allowBus&&!s.postedJSON.allowTrain&&!s.postedJSON.allowMetro){var c="/?"+a+"&"+t;console.log("bus only - "+c),r.set("url",c);var u=s.searchFilters.operator;r.set("operator",u)}if(s.postedJSON.allowBus&&s.postedJSON.allowTrain&&!s.postedJSON.allowMetro){var c="/?"+a+"&"+o+"&"+t;console.log(c),r.set("url",c)}if(s.postedJSON.allowBus&&!s.postedJSON.allowTrain&&s.postedJSON.allowMetro){var c="/?"+a+"&"+n+"&"+t;console.log(c),r.set("url",c)}if(!s.postedJSON.allowBus&&s.postedJSON.allowTrain&&!s.postedJSON.allowMetro){var c="/?"+o+"&"+t;console.log(c),r.set("url",c)}if(!s.postedJSON.allowBus&&s.postedJSON.allowTrain&&s.postedJSON.allowMetro){var c="/?"+o+"&"+n+"&"+t;console.log(c),r.set("url",c)}if(!s.postedJSON.allowBus&&!s.postedJSON.allowTrain&&s.postedJSON.allowMetro){var c="/?"+n+"&"+t;console.log(c),r.set("url",c)}if(s.postedJSON.allowBus&&s.postedJSON.allowTrain&&s.postedJSON.allowMetro){var c="/?"+a+"&"+o+"&"+n+"&"+t;console.log(c),r.set("url",c)}if(!s.postedJSON.allowBus&&!s.postedJSON.allowTrain&&!s.postedJSON.allowMetro){var c="/?"+t;console.log(c),r.set("url",c)}}},82,!1)},82,!1)},s.update=function(){var e=s.all,t=s.exactMatch,r=s.otherResults;console.log("Search Filters"),console.log(s.searchFilters),angular.forEach(s.searchFilters,function(e,t){(-1!==t.indexOf("allow")&&e||0==e&&-1===t.indexOf("allow"))&&delete s.searchFilters[t]}),e=a("filter")(e,s.searchFilters),t=a("filter")(t,s.searchFilters),r=a("filter")(r,s.searchFilters),s.filteredTickets=a("orderBy")(e,s.orderBy),s.origTickets=a("orderBy")(t,s.orderBy),s.otherTickets=a("orderBy")(r,s.orderBy),o.search().buyOnDirectDebit&&console.log("Direct Debit Test"),s.updateGrid()},s.loadMore=function(){s.limit+=6,o.search("limit",s.limit),s.updateGrid()},s.loadMoreExact=function(){s.limitExact+=6,o.search("limitExact",s.limitExact),s.updateGrid()},s.filterButtons={operator:[],operatorLength:0,busTravelArea:[],railZoneFrom:[],railZoneTo:[]},s.toggleFilter=function(e){s.filterButtons[e]=!s.filterButtons[e]},s.toggleFilterClose=function(){$(".filter-title").collapse("hide")},s.swiftPAYG=h,s.ntrainOOC=function(){s.passValue=s.postJSON.brand,"ntrain - Out of County"==s.passValue&&(s.isHideCheck=!s.isHideCheck)},s.toggleModalSwift=function(){s.modalShownSwift=!s.modalShownSwift},c(),o.search().allowBus||o.search().allowMetro||o.search().allowTrain||o.search().brand&&o.search().passengerType&&o.search().timeBand||o.search().busTravelArea||o.search().operator||o.search().stationNames||o.search().brand?(s.clearStation(),u(s.postJSON)):o.url("").replace();"Swift PAYG"==o.search().brand&&(p(),h());function u(t){s.loadingStatus="loading",angular.copy(s.postJSON,s.postedJSON),o.search({allowBus:s.postedJSON.allowBus,allowTrain:s.postedJSON.allowTrain,allowMetro:s.postedJSON.allowMetro,passengerType:s.postedJSON.passengerType,timeBand:s.postedJSON.timeBand,busTravelArea:s.postedJSON.busTravelArea,operator:s.postedJSON.operator,brand:s.postedJSON.brand,stationNames:s.postedJSON.stationNames,buyOnDirectDebit:e.buyOnDirectDebitParameter,buyOnDirectPurchase:e.buyOnDirectPurchaseParameter,buyOnSwift:e.buyOnSwiftParameter,hasOnlinePurchaseChannel:e.hasOnlinePurchaseChannelParameter,purchaseTic:e.purchaseTicParameter,purchaseRailStation:e.purchaseRailStationParameter,purchasePayzone:e.purchasePayzoneParameter,busTravelArea:e.busTravelAreaParameter,limit:s.limit,limitExact:s.limitExact}),s.searchFilters={},s.origFilters={},console.log("this is posted"),console.log(s.postedJSON),n.ticketSearch(t).then(function(e){s.all=e;var t=s.postedJSON.allowBus||!1,o=s.postedJSON.allowTrain||!1,r=s.postedJSON.allowMetro||!1;s.postedJSON.passengerType;s.exactMatch=a("filter")(e,{allowBus:t,allowTrain:o,allowMetro:r},!0);for(var n=s.all,l=s.exactMatch,i=0;i<l.length;i++)for(var c=n.length,u=0;u<c;u++)l[i]==n[u]&&(n=n.slice(0,u).concat(n.slice(u+1,c)));s.otherResults=n}),n.ticketSearch(t).then(function(t){if(s.all=t,console.log("ticket search"),console.log(t),s.original=t,angular.forEach(s.all,function(e){-1==s.filterButtons.operator.indexOf(e.operator)&&s.filterButtons.operator.push(e.operator),-1==s.filterButtons.busTravelArea.indexOf(e.busTravelArea)&&s.filterButtons.busTravelArea.push(e.busTravelArea),-1==s.filterButtons.railZoneFrom.indexOf(e.railZoneFrom)&&s.filterButtons.railZoneFrom.push(e.railZoneFrom),-1==s.filterButtons.railZoneTo.indexOf(e.railZoneTo)&&s.filterButtons.railZoneTo.push(e.railZoneTo)}),o.search().stationNames){var a=o.search().stationNames,r=a.toString(),n=r.split(",");e.stationFromName=n[0],e.stationToName=n[1];var l=s.postedJSON.allowBus,i=s.postedJSON.allowTrain,c=s.postedJSON.allowMetro}(null!=l||null!=l&&null!=i||null!=l&&null!=c||null!=i&&null!=c)&&s.toggleFilter("mode"),null!=l&&null!=i&&null!=c&&s.toggleFilter("payment"),s.update(),s.loadingStatus="success"})}function d(){s.postJSON.allowBus=null,s.postJSON.allowTrain=null,s.postJSON.allowMetro=null}e.stationFromName=null,e.stationFromReq=!1,e.stationFrom=function(t){t?(e.stationFromName=t.originalObject.name,s.postJSON.stationNames[0]=t.originalObject.name,e.stationFromTitle=t.originalObject.name,e.stationFromNameZone=t.originalObject.zone,e.stationFromNameOoc=t.originalObject.outOfCounty,e.stationFromNameOocZ5=t.originalObject.zone5InCounty,e.stationToReq=!0):(e.stationFromName=null,s.postJSON.stationNames[0]=null,e.stationFromTitle=null)},e.stationToName=null,e.stationToReq=!1,e.stationTo=function(t){t?(e.stationToName=t.originalObject.name,s.postJSON.stationNames[1]=t.originalObject.name,e.stationToTitle=t.originalObject.name,e.stationToNameZone=t.originalObject.zone,e.stationToNameOoc=t.originalObject.outOfCounty,e.stationToNameOocZ5=t.originalObject.zone5InCounty,e.stationFromReq=!0):(e.stationToName=null,s.postJSON.stationNames[1]=null,e.stationToTitle=null)},e.buyOnDirectDebitParameter&&(s.filterButtons.payment=!s.filterButtons.payment,s.searchFilters.buyOnDirectDebit=!0,e.buyOnDirectDebitCheck=function(){return!0});e.buyOnDirectPurchaseParameter&&(s.filterButtons.payment=!s.filterButtons.payment,s.searchFilters.buyOnDirectPurchase=!0,e.buyOnDirectPurchaseCheck=function(){return!0});e.buyOnSwiftParameter&&(s.filterButtons.payment=!s.filterButtons.payment,s.searchFilters.buyOnSwift=!0,e.buyOnSwiftCheck=function(){return!0});e.hasOnlinePurchaseChannelParameter&&(s.filterButtons.payment=!s.filterButtons.payment,s.searchFilters.hasOnlinePurchaseChannel=!0,e.hasOnlinePurchaseChannelCheck=function(){return!0});e.purchaseTicParameter&&(s.filterButtons.payment=!s.filterButtons.payment,s.searchFilters.purchaseTic=!0,e.purchaseTicCheck=function(){return!0});e.purchaseRailStationParameter&&(s.filterButtons.payment=!s.filterButtons.payment,s.searchFilters.purchaseRailStation=!0,e.purchaseRailStationCheck=function(){return!0});e.purchasePayzoneParameter&&(s.filterButtons.payment=!s.filterButtons.payment,s.searchFilters.purchasePayzone=!0,e.purchasePayzoneCheck=function(){return!0});e.busAreaTest=!1,e.busTravelAreaParameter&&(s.filterButtons.busTravelAreaBtn=!s.filterButtons.busTravelAreaBtn,e.busTravelAreaCheck=function(){console.log("yes"),"Walsall"==e.busTravelAreaParameter&&(e.busAreaTest=!0)},e.busTravelAreaChecknull=function(){console.log("no")},console.log("postes test"),console.log(e.busTravelAreaParameter),"Walsall"==e.busTravelAreaParameter&&(console.log("Walsall selected"),e.busTravelArea="$scope.busTravelAreaParameter",e.doSomething=function(e){console.log("area"),console.log(e)}));if("Walsall"==e.busTravelAreaParameter)return e.busAreaTest=!0,!0;function h(){s.passValue=s.postJSON.brand,"Swift PAYG"==s.passValue?(s.isHideCheck=!s.isHideCheck,s.postJSON.passengerType=null,s.postJSON.timeBand=null,s.postJSON.stationNames=[]):"nbus"!=s.passValue&&"National Express"!=s.passValue&&"Diamond Bus"!=s.passValue&&"Stagecoach"!=s.passValue&&"Swift PAYG"!=s.passValue&&"West Midlands Metro"!=s.passValue||(s.postJSON.stationNames=[[]])}function p(){n.getSwiftSearch().then(function(e){s.swiftPaygTickets=e,console.log("swift search"),console.log(e)})}e.busTravelAreaChecktest=function(){if("Walsall"==e.busTravelAreaParameter)return e.busAreaTest=!0,!0},e.busTravelAreaChecknulltest=function(){return console.log("no"),!0},s.modalShownSwift=!1,e.date=new Date}]).filter("removeHTMLTags",[function(){return function(e){return e?String(e).replace(/<[^>]+>/gm,""):""}}]).filter("modeFilter",[function(){return function(e,t){return angular.forEach({},function(e,t){}),angular.forEach(e,function(e){}),[]}}]).filter("escapeFilter",[function(){return function(e){return e?String(e).replace(/\n/gm,"<br><br>"):""}}]).filter("replace",[function(){return function(e,t,a){if(void 0!==e){var o=new RegExp(t,"g");return e.replace(o,a)}}}]).filter("buyOnSwiftPAYG",[function(){return function(e,t,a){if(void 0!==e){var o=new RegExp(t,"g");return e.replace(o,a)}}}]).directive("initialSearch",[function(){return{templateUrl:"partials/search-results/initial-search.html",restrict:"E"}}]).directive("searchResults",[function(){return{templateUrl:"partials/search-results/search-results.html",restrict:"E"}}]).directive("filters",[function(){return{templateUrl:"partials/search-results/filters.html",restrict:"E"}}]).directive("item",["$timeout","angularGridInstance",function(e,t){return{templateUrl:"partials/search-results/item.html",restrict:"E",link:function(a,o,r){e(function(){a.$last&&t.ticketResults.refresh()},0)}}}]).controller("TicketDetailCtrl",["ticketingService","$interval","getURL","$routeParams","$scope","$timeout",function(e,t,a,o,r,n){var l=this;l.loadingText="Loading...",l.loadingStatus="loading",l.loadingArray=["Well, what are you waiting for?","Are we there yet?","Warming up the processors...","Reconfiguring the office coffee machine...","Doing something useful...","Are you ready?","So, do you come here often?","This may take some time...","I know this is painful to watch, but I have to load this.","Oh, no! Loading time...","Still Waiting... huh","Waiting for something in the server.","Creating randomly generated feature.","It's not you. It's me.","Eating your internet cookies...Yummy!"],l.loading=t(function(){l.loadingText=l.loadingArray[Math.round(Math.random()*(l.loadingArray.length-1))]},3500),l.ticketID=o.ticket,l.filterAccordions={},l.relatedTickets={},l.toggleClick=function(e){l.filterAccordions[e]=!l.filterAccordions[e]},l.modalShown=!1,l.toggleModal=function(){l.modalShown=!l.modalShown},l.toggleModalBus=function(){l.modalShownBus=!l.modalShownBus},l.toggleModalTrain=function(){l.modalShownTrain=!l.modalShownTrain},l.toggleModalSwift=function(){l.modalShownSwift=!l.modalShownSwift},l.operatorList=[],l.checkStations=function(){console.log("hello"+sessionStorage.getItem(savedData))},l.limit=4,i=l.ticketID,e.getTicket(i).then(function(t){l.all=t,console.log(t),l.all.relatedTickets.length&&angular.forEach(l.all.relatedTickets,function(t){e.getSimpleTicket(t.id).then(function(e){l.relatedTickets[t.id]=e})}),l.all.documents.length&&e.getTerms(i).then(function(e){l.relatedTerms=e}),e.getOperators().then(function(e){l.operatorList=e,console.log(e)}),l.backToSearch=a,console.log(l.backToSearch),r.stationFromNameZone="1"}),l.modalShownBus=!1,l.modalShownTrain=!1,l.modalShown=!1,l.modalShownSwift=!1,n(function(){l.loadingStatus="success"},2e3);var i}]).directive("detailDetails",[function(){return{templateUrl:"partials/detail/details.html",restrict:"E"}}]).directive("detailSidebar",[function(){return{templateUrl:"partials/detail/sidebar.html",restrict:"E"}}]).directive("detailAlternative",[function(){return{templateUrl:"partials/detail/alternative.html",restrict:"E"}}]).directive("detailRelated",["$timeout","angularGridInstance",function(e,t){return{templateUrl:"partials/detail/related-product.html",restrict:"E",link:function(a,o,r){e(function(){a.$last&&t.alternativeResults.refresh()},0)}}}]).directive("operators",[function(){return{templateUrl:"partials/detail/operator.html",restrict:"E"}}]).directive("modalDialog",[function(){return{restrict:"E",scope:{show:"="},replace:!0,transclude:!0,link:function(e,t,a){e.dialogStyle={},a.width&&(e.dialogStyle.width=a.width),a.height&&(e.dialogStyle.height=a.height),a.modalclass&&(e.dialogStyle.class=a.modalclass),e.hideModal=function(){e.show=!1}},template:'<div ng-show="show"><div ng-show="show" class="modal" ng-click="hideModal()"></div><div class="ng-modal-dialog boxin modal-content {{dialogStyle.class}}" ng-style="dialogStyle"><div class="ng-modal-close modal__close js-modal-close" ng-click="hideModal()">X</div><div class="ng-modal-dialog-content" ng-transclude></div></div></div>'}}]).directive("tabs",[function(){return{restrict:"E",transclude:!0,scope:{},controller:["$scope",function(e){var t=e.panes=[];e.select=function(e){angular.forEach(t,function(e){e.selected=!1}),e.selected=!0},this.addPane=function(a){0==t.length&&e.select(a),t.push(a)}}],template:'<div class="cfx"><div class="arrdep-filters__toggle"><div class="radio-bar"><span ng-repeat="pane in panes" ng-class="{active:pane.selected}"><input name="option" id="{{pane.title}}" type="radio"><label ng-click="select(pane)" for="{{pane.title}}" style="height: 44px;">{{pane.title}}</label></span></div></div><div class="tab-content" ng-transclude></div></div>',replace:!0}}]).directive("pane",[function(){return{require:"^tabs",restrict:"E",transclude:!0,scope:{title:"@"},link:function(e,t,a,o){o.addPane(e)},template:'<div class="tab-pane" ng-class="{active: selected}" ng-transclude></div>',replace:!0}}]).directive("tooltip",[function(){return{restrict:"A",controller:function(e,t){e.isShown=!1,this.showHover=function(){e.isShown=1!=e.isShown}},transclude:!0,link:function(e,t,a,o){e.copy=a.tooltipc,t.bind("click",function(){e.$apply(function(){o.showHover()})})},template:'<div ng-transclude></div><p class="field-help tooltip" ng-show="isShown"><span class="close modal__close"></span><span data-ng-bind-html="copy"></span></p>'}}])}();