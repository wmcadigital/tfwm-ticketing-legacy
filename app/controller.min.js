!function(){"use strict";function t(){vm.modalShowFilter=!vm.modalShowFilter}angular.module("ticketingApp.Controller",["angucomplete-alt"]).controller("TicketingSearchCtrl",["$scope","$timeout","$filter","$location","savedFilter","ticketingService","angularGridInstance","$httpParamSerializer",function(e,a,r,n,o,i,l,s){var c=this;function u(){c.all=[],c.filteredTickets=[],c.origTickets=[],c.otherTickets=[],c.stationList=[],c.stationoocList=[],c.stationicList=[],c.swiftPaygTickets=[],c.loadingStatus="",c.passValue="",c.orderBy="orderSequence",c.limit=parseInt(n.search().limit)||6,c.limitExact=parseInt(n.search().limitExact)||6,c.postJSON={allowBus:n.search().allowBus||null,allowMetro:n.search().allowMetro||null,allowTrain:n.search().allowTrain||null,passengerType:n.search().passengerType||"",timeBand:n.search().timeBand||"",brand:n.search().brand||null,stationNames:n.search().stationNames||[[]]},e.stationFromName=null,e.stationToName=null,e.stationFromTitle=null,e.stationToTitle=null,e.stationFromNameOocZ5=null,e.stationToNameOocZ5=null,c.toggleModalSwift=p,c.toggleModalFilters=t,e.buyOnDirectDebitParameter=n.search().buyOnDirectDebit||null,e.buyOnDirectPurchaseParameter=n.search().buyOnDirectPurchase||null,e.buyOnSwiftParameter=n.search().buyOnSwift||null,e.hasOnlinePurchaseChannelParameter=n.search().hasOnlinePurchaseChannel||null,e.purchaseTicParameter=n.search().purchaseTic||null,e.purchaseRailStationParameter=n.search().purchaseRailStation||null,e.purchasePayzoneParameter=n.search().purchasePayzone||null,e.busTravelAreaParameter=n.search().busTravelArea||null,e.operatorParameter=n.search().operator||null,e.railZoneFromParameter=n.search().railZoneFrom||null,e.railZoneToParameter=n.search().railZoneTo||null,c.clearModes=d,c.postedJSON={},e.stationFromReq=!1,e.stationToReq=!1}e.assetPath=assetPath,e.ticketUrl=ticketUrl,c.submit=h,c.clearFilter=function(){n.url("").replace(),u(),e.buyOnDirectDebitCheck=function(){return!1},e.buyOnDirectPurchaseCheck=function(){return!1},e.buyOnSwiftCheck=function(){return!1},e.hasOnlinePurchaseChannelCheck=function(){return!1},e.purchaseTicCheck=function(){return!1},e.purchaseRailStationCheck=function(){return!1},e.purchasePayzoneCheck=function(){return!1},o.set("url","")},c.getStations=function(){i.getStations().then(function(t){c.stationList=t})},c.getoocStations=function(){i.getStations().then(function(t){var e=r("filter")(t,{outOfCounty:"true"});c.stationoocList=e})},c.geticStations=function(){i.getStations().then(function(t){var e=r("filter")(t,{outOfCounty:"false"});c.stationicList=e})},c.clearFromStation=function(){e.$broadcast("angucomplete-alt:clearInput","stationFrom"),e.stationFromName=null,c.postJSON.stationNames=[[]],e.stationFromReq=!1,e.stationFromNameOocZ5=null},c.clearToStation=function(){e.$broadcast("angucomplete-alt:clearInput","stationTo"),e.stationToName=null,c.postJSON.stationNames=[[]],e.stationToReq=!1,e.stationToNameOocZ5=null},c.clearStation=function(){"[]"===n.search().stationNames&&c.clearFromStation()},c.getSwiftPAYG=f,c.updateGrid=function(){a(function(){a(function(){if(c.filteredTickets.length){l.ticketResults.refresh(),l.origTicketResults.refresh();var t,e,a,r,n={passengerType:c.postedJSON.passengerType,timeBand:c.postedJSON.timeBand,brand:c.postedJSON.brand,stationNames:c.postedJSON.stationNames,busTravelArea:c.searchFilters.busTravelArea,operator:c.searchFilters.operator,buyOnDirectDebit:c.searchFilters.buyOnDirectDebit,buyOnDirectPurchase:c.searchFilters.buyOnDirectPurchase||null,buyOnSwift:c.searchFilters.buyOnSwift,hasOnlinePurchaseChannel:c.searchFilters.hasOnlinePurchaseChannel,purchaseTic:c.searchFilters.purchaseTic,purchaseRailStation:c.searchFilters.purchaseRailStation,purchasePayzone:c.searchFilters.purchasePayzone,railZoneFrom:c.searchFilters.railZoneFrom,railZoneTo:c.searchFilters.railZoneTo,limit:c.limit,limitExact:c.limitExact},i=s(n);c.postedJSON.allowBus&&(t="allowBus"),c.postedJSON.allowTrain&&(e="allowTrain"),c.postedJSON.allowMetro&&(a="allowMetro"),!c.postedJSON.allowBus||c.postedJSON.allowTrain||c.postedJSON.allowMetro||(r="/?"+t+"&"+i,o.set("url",r)),c.postedJSON.allowBus&&c.postedJSON.allowTrain&&!c.postedJSON.allowMetro&&(r="/?"+t+"&"+e+"&"+i,o.set("url",r)),c.postedJSON.allowBus&&!c.postedJSON.allowTrain&&c.postedJSON.allowMetro&&(r="/?"+t+"&"+a+"&"+i,o.set("url",r)),c.postedJSON.allowBus||!c.postedJSON.allowTrain||c.postedJSON.allowMetro||(r="/?"+e+"&"+i,o.set("url",r)),!c.postedJSON.allowBus&&c.postedJSON.allowTrain&&c.postedJSON.allowMetro&&(r="/?"+e+"&"+a+"&"+i,o.set("url",r)),c.postedJSON.allowBus||c.postedJSON.allowTrain||!c.postedJSON.allowMetro||(r="/?"+a+"&"+i,o.set("url",r)),c.postedJSON.allowBus&&c.postedJSON.allowTrain&&c.postedJSON.allowMetro&&(r="/?"+t+"&"+e+"&"+a+"&"+i,o.set("url",r)),c.postedJSON.allowBus||c.postedJSON.allowTrain||c.postedJSON.allowMetro||(r="/?"+i,o.set("url",r))}},0,!1)},0,!1)},c.update=function(){var t=c.all,e=c.exactMatch,a=c.otherResults;angular.forEach(c.searchFilters,function(t,e){(-1!==e.indexOf("allow")&&t||!1===t&&-1===e.indexOf("allow"))&&delete c.searchFilters[e]}),t=r("filter")(t,c.searchFilters),e=r("filter")(e,c.searchFilters),a=r("filter")(a,c.searchFilters),c.filteredTickets=r("orderBy")(t,c.orderBy),c.origTickets=r("orderBy")(e,c.orderBy),c.otherTickets=r("orderBy")(a,c.orderBy),c.updateGrid()},c.loadMore=function(){c.limit+=6,n.search("limit",c.limit),c.updateGrid()},c.loadMoreExact=function(){c.limitExact+=6,n.search("limitExact",c.limitExact),c.updateGrid()},c.filterButtons={operator:[],operatorLength:0,busTravelArea:[],railZoneFrom:[],railZoneTo:[]},c.toggleFilter=function(t){c.filterButtons[t]=!c.filterButtons[t]},c.swiftPAYG=m,c.ntrainOOC=function(){c.passValue=c.postJSON.brand,"ntrain - Out of County"===c.passValue&&(c.isHideCheck=!c.isHideCheck)},c.toggleModalSwift=p,u(),n.search().allowBus||n.search().allowMetro||n.search().allowTrain||n.search().brand&&n.search().passengerType&&n.search().timeBand||n.search().busTravelArea||n.search().operator||n.search().stationNames||n.search().brand?(c.clearStation(),h(c.postJSON)):n.url("").replace();e.showDetails=!1,"Swift PAYG"===n.search().brand&&(f(),m());function h(t){c.loadingStatus="loading",angular.copy(c.postJSON,c.postedJSON),n.search({allowBus:c.postedJSON.allowBus,allowTrain:c.postedJSON.allowTrain,allowMetro:c.postedJSON.allowMetro,passengerType:c.postedJSON.passengerType,timeBand:c.postedJSON.timeBand,brand:c.postedJSON.brand,stationNames:c.postedJSON.stationNames,buyOnDirectDebit:e.buyOnDirectDebitParameter,buyOnDirectPurchase:e.buyOnDirectPurchaseParameter,buyOnSwift:e.buyOnSwiftParameter,hasOnlinePurchaseChannel:e.hasOnlinePurchaseChannelParameter,purchaseTic:e.purchaseTicParameter,purchaseRailStation:e.purchaseRailStationParameter,purchasePayzone:e.purchasePayzoneParameter,busTravelArea:e.busTravelAreaParameter,operator:e.operatorParameter,railZoneFrom:e.railZoneFromParameter,railZoneTo:e.railZoneToParameter,limit:c.limit,limitExact:c.limitExact}),c.searchFilters={},c.origFilters={},i.ticketSearch(t).then(function(t){c.all=t,c.original=t,angular.forEach(c.all,function(t){-1===c.filterButtons.operator.indexOf(t.operator)&&c.filterButtons.operator.push(t.operator),-1===c.filterButtons.busTravelArea.indexOf(t.busTravelArea)&&c.filterButtons.busTravelArea.push(t.busTravelArea),-1===c.filterButtons.railZoneFrom.indexOf(t.railZoneFrom)&&c.filterButtons.railZoneFrom.push(t.railZoneFrom),-1===c.filterButtons.railZoneTo.indexOf(t.railZoneTo)&&c.filterButtons.railZoneTo.push(t.railZoneTo)});var a=c.postedJSON.allowBus||!1,o=c.postedJSON.allowTrain||!1,i=c.postedJSON.allowMetro||!1;c.exactMatch=r("filter")(t,{allowBus:a,allowTrain:o,allowMetro:i},!0);for(var l=c.all,s=c.exactMatch,u=0;u<s.length;u++)for(var h=l.length,d=0;d<h;d++)s[u]===l[d]&&(l=l.slice(0,d).concat(l.slice(d+1,h)));if(c.otherResults=l,n.search().stationNames){var p=n.search().stationNames,m=p.toString(),f=m.split(",");e.stationFromName=f[0],e.stationToName=f[1]}var S=c.postedJSON.allowBus,g=c.postedJSON.allowTrain,O=c.postedJSON.allowMetro;(null!==S||null!==S&&null!==g||null!==S&&null!==O||null!==g&&null!==O)&&c.toggleFilter("mode"),null!==S&&null!==g&&null!==O&&c.toggleFilter("payment"),c.update(),c.loadingStatus="success"})}function d(){c.postJSON.allowBus=null,c.postJSON.allowTrain=null,c.postJSON.allowMetro=null}e.stationFromName=null,e.stationFromReq=!1,e.stationFrom=function(t){t?(e.stationFromName=t.originalObject.name,c.postJSON.stationNames[0]=t.originalObject.name,e.stationFromTitle=t.originalObject.name,e.stationFromNameZone=t.originalObject.zone,e.stationFromNameOoc=t.originalObject.outOfCounty,e.stationFromNameOocZ5=t.originalObject.zone5InCounty,e.stationToReq=!0):(e.stationFromName=null,c.postJSON.stationNames[0]=null,e.stationFromTitle=null)},e.stationToName=null,e.stationToReq=!1,e.stationTo=function(t){t?(e.stationToName=t.originalObject.name,c.postJSON.stationNames[1]=t.originalObject.name,e.stationToTitle=t.originalObject.name,e.stationToNameZone=t.originalObject.zone,e.stationToNameOoc=t.originalObject.outOfCounty,e.stationToNameOocZ5=t.originalObject.zone5InCounty,e.stationFromReq=!0):(e.stationToName=null,c.postJSON.stationNames[1]=null,e.stationToTitle=null)},e.buyOnDirectDebitParameter&&(c.filterButtons.payment=!c.filterButtons.payment,c.searchFilters.buyOnDirectDebit=!0,e.buyOnDirectDebitCheck=function(){return!0});e.buyOnDirectPurchaseParameter&&(c.filterButtons.payment=!c.filterButtons.payment,c.searchFilters.buyOnDirectPurchase=!0,e.buyOnDirectPurchaseCheck=function(){return!0});e.buyOnSwiftParameter&&(c.filterButtons.payment=!c.filterButtons.payment,c.searchFilters.buyOnSwift=!0,e.buyOnSwiftCheck=function(){return!0});e.hasOnlinePurchaseChannelParameter&&(c.filterButtons.payment=!c.filterButtons.payment,c.searchFilters.hasOnlinePurchaseChannel=!0,e.hasOnlinePurchaseChannelCheck=function(){return!0});e.purchaseTicParameter&&(c.filterButtons.payment=!c.filterButtons.payment,c.searchFilters.purchaseTic=!0,e.purchaseTicCheck=function(){return!0});e.purchaseRailStationParameter&&(c.filterButtons.payment=!c.filterButtons.payment,c.searchFilters.purchaseRailStation=!0,e.purchaseRailStationCheck=function(){return!0});e.purchasePayzoneParameter&&(c.filterButtons.payment=!c.filterButtons.payment,c.searchFilters.purchasePayzone=!0,e.purchasePayzoneCheck=function(){return!0});e.busTravelAreaParameter&&(c.filterButtons.busTravelAreaBtn=!c.filterButtons.busTravelAreaBtn,c.searchFilters.busTravelArea=e.busTravelAreaParameter);e.operatorParameter&&(c.filterButtons.operatorBtn=!c.filterButtons.operatorBtn,c.searchFilters.operator=e.operatorParameter);e.railZoneFromParameter&&(c.filterButtons.railZoneBtn=!c.filterButtons.railZoneBtn,c.searchFilters.railZoneFrom=e.railZoneFromParameter);e.railZoneToParameter&&(c.filterButtons.railZoneBtn=!c.filterButtons.railZoneBtn,c.searchFilters.railZoneTo=e.railZoneToParameter);function p(){c.modalShownSwift=!c.modalShownSwift}function m(){c.passValue=c.postJSON.brand,"Swift PAYG"===c.passValue?(c.isHideCheck=!c.isHideCheck,c.postJSON.passengerType=null,c.postJSON.timeBand=null,c.postJSON.stationNames=[]):"nbus"!==c.passValue&&"National Express"!==c.passValue&&"Diamond Bus"!==c.passValue&&"Stagecoach"!==c.passValue&&"Swift PAYG"!==c.passValue&&"West Midlands Metro"!==c.passValue||(c.postJSON.stationNames=[[]])}function f(){i.getSwiftSearch().then(function(t){c.swiftPaygTickets=t})}c.modalShownSwift=!1,e.date=new Date}]).filter("removeHTMLTags",[function(){return function(t){return t?String(t).replace(/<[^>]+>/gm,""):""}}]).filter("escapeFilter",[function(){return function(t){return t?String(t).replace(/\n/gm,"<br><br>"):""}}]).filter("replace",[function(){return function(t,e,a){if(void 0!==t){var r=new RegExp(e,"g");return t.replace(r,a)}}}]).directive("initialSearch",[function(){return{templateUrl:assetPath+"partials/search-results/initial-search.html",restrict:"E"}}]).directive("searchResults",[function(){return{templateUrl:assetPath+"partials/search-results/search-results.html",restrict:"E"}}]).directive("filters",[function(){return{templateUrl:assetPath+"partials/search-results/filters.html",restrict:"E"}}]).directive("item",["$timeout","angularGridInstance",function(t,e){return{templateUrl:assetPath+"partials/search-results/item.html",restrict:"E",link:function(a,r,n){t(function(){a.$last&&e.ticketResults.refresh()},1e3)}}}]).controller("TicketDetailCtrl",["ticketingService","$interval","getURL","$routeParams","$scope","$timeout",function(t,e,a,r,n,o){var i=this;n.assetPath=assetPath,n.ticketUrl=ticketUrl,i.loadingText="Loading...",i.loadingStatus="loading",i.loadingArray=["Well, what are you waiting for?","Are we there yet?","Warming up the processors...","Reconfiguring the office coffee machine...","Doing something useful...","Are you ready?","So, do you come here often?","This may take some time...","I know this is painful to watch, but I have to load this.","Oh, no! Loading time...","Still Waiting... huh","Waiting for something in the server.","Creating randomly generated feature.","It's not you. It's me.","Eating your internet cookies...Yummy!"],i.loading=e(function(){i.loadingText=i.loadingArray[Math.round(Math.random()*(i.loadingArray.length-1))]},3500),i.ticketID=r.ticket,i.filterAccordions={},i.relatedTickets={},i.toggleClick=function(t){i.filterAccordions[t]=!i.filterAccordions[t]},i.modalShown=!1,i.toggleModal=function(){i.modalShown=!i.modalShown},i.toggleModalBus=function(){i.modalShownBus=!i.modalShownBus},i.toggleModalTrain=function(){i.modalShownTrain=!i.modalShownTrain},i.toggleModalSwift=function(){i.modalShownSwift=!i.modalShownSwift},i.operatorList=[],i.limit=4,l=i.ticketID,t.getTicket(l).then(function(e){i.all=e,i.all.relatedTickets.length&&angular.forEach(i.all.relatedTickets,function(e){t.getSimpleTicket(e.id).then(function(t){i.relatedTickets[e.id]=t})}),i.all.documents.length&&t.getTerms(l).then(function(t){i.relatedTerms=t}),t.getOperators().then(function(t){i.operatorList=t}),i.backToSearch=a,n.stationFromNameZone="1"}),i.modalShownBus=!1,i.modalShownTrain=!1,i.modalShown=!1,i.modalShownSwift=!1,o(function(){i.loadingStatus="success"},0);var l}]).directive("detailDetails",[function(){return{templateUrl:assetPath+"partials/detail/details.html",restrict:"E"}}]).directive("detailSidebar",[function(){return{templateUrl:assetPath+"partials/detail/sidebar.html",restrict:"E"}}]).directive("detailAlternative",[function(){return{templateUrl:assetPath+"partials/detail/alternative.html",restrict:"E"}}]).directive("detailRelated",["$timeout","angularGridInstance",function(t,e){return{templateUrl:assetPath+"partials/detail/related-product.html",restrict:"E",link:function(a,r,n){t(function(){a.$last&&e.alternativeResults.refresh()},0)}}}]).directive("operators",[function(){return{templateUrl:assetPath+"partials/detail/operator.html",restrict:"E"}}]).directive("modalDialog",[function(){return{restrict:"E",scope:{show:"="},replace:!0,transclude:!0,link:function(t,e,a){t.dialogStyle={},a.width&&(t.dialogStyle.width=a.width),a.height&&(t.dialogStyle.height=a.height),a.modalclass&&(t.dialogStyle.class=a.modalclass),t.hideModal=function(){t.show=!1}},template:'<div ng-show="show"><div ng-show="show" class="modal" ng-click="hideModal()"></div><div class="ng-modal-dialog boxin modal-content {{dialogStyle.class}}" ng-style="dialogStyle"><div class="ng-modal-close modal__close js-modal-close" ng-click="hideModal()">X</div><div class="ng-modal-dialog-content" ng-transclude></div></div></div>'}}]).directive("tabs",[function(){return{restrict:"E",transclude:!0,scope:{},controller:["$scope",function(t){var e=t.panes=[];t.select=function(t){angular.forEach(e,function(t){t.selected=!1}),t.selected=!0},this.addPane=function(a){0==e.length&&t.select(a),e.push(a)}}],template:'<div class="cfx"><div class="arrdep-filters__toggle"><div class="radio-bar"><span ng-repeat="pane in panes" ng-class="{active:pane.selected}"><input name="option" id="{{pane.title}}" type="radio"><label ng-click="select(pane)" for="{{pane.title}}" style="height: 44px;">{{pane.title}}</label></span></div></div><div class="tab-content" ng-transclude></div></div>',replace:!0}}]).directive("pane",[function(){return{require:"^tabs",restrict:"E",transclude:!0,scope:{title:"@"},link:function(t,e,a,r){r.addPane(t)},template:'<div class="tab-pane" ng-class="{active: selected}" ng-transclude></div>',replace:!0}}]).directive("tooltip",[function(){return{restrict:"A",controller:["$scope",function(t,e){t.isShown=!1,this.showHover=function(){t.isShown=1!=t.isShown}}],transclude:!0,link:function(t,e,a,r){t.copy=a.tooltipc,e.bind("click",function(){t.$apply(function(){r.showHover()})})},template:'<div ng-transclude></div><p class="field-help tooltip" ng-show="isShown"><span class="close modal__close"></span><span data-ng-bind-html="copy"></span></p>'}}]),vm.modalShowFilter=!1}();